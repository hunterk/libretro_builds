name: ffmpeg libretro Windows x64

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # ----------------------------
      # Checkout RetroArch
      # ----------------------------
      - name: Checkout RetroArch source
        uses: actions/checkout@v4
        with:
          repository: libretro/RetroArch
          submodules: recursive
          path: RetroArch

      # ----------------------------
      # Install Visual Studio Build Tools
      # ----------------------------
      - name: Install MSVC build tools
        uses: microsoft/setup-msbuild@v2

      # ----------------------------
      # Install Python + Meson + Ninja
      # ----------------------------
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Meson + Ninja
        run: |
          pip install meson ninja

      # ----------------------------
      # Clone FFmpeg
      # ----------------------------
      - name: Download FFmpeg source
        run: |
          git clone https://github.com/FFmpeg/FFmpeg.git ffmpeg-src
          cd ffmpeg-src
          git checkout release/6.1

      # ----------------------------
      # Build FFmpeg (MSVC + Meson)
      # ----------------------------
      - name: Build FFmpeg with MSVC
        shell: cmd
        run: |
          REM Enter MSVC environment
          CALL "%ProgramFiles(x86)%\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"

          cd ffmpeg-src

          REM Configure Meson build
          meson setup build-msvc ^
            --buildtype=release ^
            --default-library=static ^
            -Denable_gpl=true ^
            -Denable_nonfree=true ^
            -Ddisable_autodetect=true ^
            -Dprotocols=file ^
            -Ddemuxers=mov,matroska,avi,mp3,aac,ogg,wav,flac ^
            -Ddecoders=mp3,aac,vorbis,flac,h264,hevc,pcm_s16le ^
            -Dswresample=enabled ^
            -Dswscale=enabled

          REM Build & install
          ninja -C build-msvc
          ninja -C build-msvc install

      # ----------------------------
      # Build libretro-ffmpeg (MSVC)
      # ----------------------------
      - name: Build libretro-ffmpeg core
        shell: cmd
        working-directory: ${{ github.workspace }}\RetroArch\cores\libretro-ffmpeg
        env:
          FFMPEG_PREFIX: ${{ github.workspace }}\ffmpeg-src\build-msvc\install
        run: |
          REM Enter MSVC environment
          CALL "%ProgramFiles(x86)%\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"

          SET INC_FFMPEG=/I "%FFMPEG_PREFIX%\include"
          SET LIB_FFMPEG="%FFMPEG_PREFIX%\lib\avcodec.lib" ^
                         "%FFMPEG_PREFIX%\lib\avformat.lib" ^
                         "%FFMPEG_PREFIX%\lib\avutil.lib" ^
                         "%FFMPEG_PREFIX%\lib\swresample.lib" ^
                         "%FFMPEG_PREFIX%\lib\swscale.lib"

          nmake /f Makefile.vc ^
            STATIC_LINK_FFMPEG=1 ^
            FFMPEG_INCLUDES="%INC_FFMPEG%" ^
            FFMPEG_LIBS="%LIB_FFMPEG%" ^
            FFMPEG_DIR="%FFMPEG_PREFIX%"

      # ----------------------------
      # Strip the DLL
      # ----------------------------
      - name: Strip libretro-ffmpeg DLL
        shell: cmd
        working-directory: ${{ github.workspace }}\\RetroArch\\cores\\libretro-ffmpeg
        run: |
          REM Strip debug symbols using llvm-strip
          "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC\15.0*\bin\Hostx64\x64\llvm-strip.exe" ^
            ffmpeg_libretro.dll

      # ----------------------------
      # Zip the core
      # ----------------------------
      - name: Zip core
        shell: powershell
        run: |
          Compress-Archive -LiteralPath "${{ github.workspace }}\RetroArch\cores\libretro-ffmpeg\ffmpeg_libretro.dll" `
                           -DestinationPath "${{ github.workspace }}\ffmpeg_libretro.dll.zip" `
                           -Force

      # ----------------------------
      # Upload release
      # ----------------------------
      - name: Publish release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: Windows_64-bit
          file: "${{ github.workspace }}\ffmpeg_libretro.dll.zip"
          overwrite: true

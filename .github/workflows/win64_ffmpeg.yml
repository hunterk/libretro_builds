name: ffmpeg libretro Windows x64

on:
  schedule:
    - cron: "0 2 * * *"
  watch:
    types: [started]
    if: github.actor == github.event.repository.owner.login

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # ----------------------------
      # Checkout RetroArch
      # ----------------------------
      - name: Checkout RetroArch source
        uses: actions/checkout@v4
        with:
          repository: libretro/RetroArch
          submodules: recursive

      # ----------------------------
      # Install MSVC environment
      # ----------------------------
      - name: Install MSVC build tools
        uses: microsoft/setup-msbuild@v2

      # ----------------------------
      # Install MSYS2 (needed for FFmpegâ€™s configure)
      # ----------------------------
      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MSYS
          install: >
            bash
            coreutils
            make
            yasm
            nasm

      # ----------------------------
      # Clone FFmpeg
      # ----------------------------
      - name: Clone FFmpeg
        run: |
          git clone https://github.com/FFmpeg/FFmpeg.git ffmpeg-src
          cd ffmpeg-src
          git checkout release/6.1

      # ----------------------------
      # Build FFmpeg with MSVC toolchain inside MSYS2
      # ----------------------------
      - name: Build FFmpeg (MSVC)
        shell: msys2 {0}
        env:
          PREFIX_WIN: ${{ github.workspace }}\ffmpeg-windows
        run: |
          # Enter MSVC environment (use Windows path)
          cmd.exe /C "\"%ProgramFiles(x86)%\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat\""

          cd ffmpeg-src

          ./configure \
            --toolchain=msvc \
            --prefix="$PREFIX_WIN" \
            --enable-static \
            --disable-shared \
            --disable-programs \
            --disable-doc \
            --disable-debug \
            --disable-autodetect \
            --disable-everything \
            --enable-protocol=file \
            --enable-demuxer=mov,matroska,avi,mp3,aac,ogg,wav,flac \
            --enable-decoder=mp3,aac,vorbis,flac,h264,hevc,pcm_s16le \
            --enable-swresample \
            --enable-swscale \
            --enable-gpl \
            --enable-nonfree

          make -j$(nproc)
          make install

      # ----------------------------
      # Build libretro-ffmpeg (MSVC)
      # ----------------------------
      - name: Build libretro-ffmpeg core
        shell: cmd
        working-directory: RetroArch\cores\libretro-ffmpeg
        env:
          PREFIX_WIN: ${{ github.workspace }}\ffmpeg-windows
        run: |
          REM Enter MSVC environment
          CALL "%ProgramFiles(x86)%\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"

          SET FFMPEG_DIR=%PREFIX_WIN%
          SET FFMPEG_INCLUDES=/I "%FFMPEG_DIR%\include"
          SET FFMPEG_LIBS="%FFMPEG_DIR%\lib\avcodec.lib" ^
                          "%FFMPEG_DIR%\lib\avformat.lib" ^
                          "%FFMPEG_DIR%\lib\avutil.lib" ^
                          "%FFMPEG_DIR%\lib\swresample.lib" ^
                          "%FFMPEG_DIR%\lib\swscale.lib"

          nmake /f Makefile.vc ^
            STATIC_LINK_FFMPEG=1 ^
            FFMPEG_DIR="%FFMPEG_DIR%" ^
            FFMPEG_INCLUDES="%FFMPEG_INCLUDES%" ^
            FFMPEG_LIBS="%FFMPEG_LIBS%"

      # ----------------------------
      # Strip DLL (optional)
      # ----------------------------
      - name: Strip libretro DLL
        shell: powershell
        working-directory: RetroArch\cores\libretro-ffmpeg
        run: |
          $strip = Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio" -Recurse -Filter llvm-strip.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($strip) {
            & $strip.FullName ffmpeg_libretro.dll
          } else {
            Write-Host "llvm-strip not found, skipping"
          }

      # ----------------------------
      # Zip core
      # ----------------------------
      - name: Zip core
        run: |
          powershell Compress-Archive `
            -LiteralPath RetroArch/cores/libretro-ffmpeg/ffmpeg_libretro.dll `
            -DestinationPath ffmpeg_libretro.dll.zip `
            -Force

      # ----------------------------
      # Upload release
      # ----------------------------
      - name: Publish release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: Windows_64-bit
          file: ffmpeg_libretro.dll.zip
          overwrite: true

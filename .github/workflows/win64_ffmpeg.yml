name: ffmpeg libretro Windows x64

on:
  schedule:
    - cron: "0 2 * * *"
  watch:
    types: [started]
    if: github.actor == github.event.repository.owner.login

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: bash

    steps:
      # ------------------------------------
      # Checkout RetroArch
      # ------------------------------------
      - name: Checkout RetroArch source
        uses: actions/checkout@v4
        with:
          repository: libretro/RetroArch
          submodules: recursive

      # ------------------------------------
      # Install MSYS2 with Clang
      # ------------------------------------
      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            base-devel git yasm pkgconf
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-lld
            mingw-w64-x86_64-llvm

      # ------------------------------------
      # Clone FFmpeg
      # ------------------------------------
      - name: Download FFmpeg source
        run: |
          git clone https://github.com/FFmpeg/FFmpeg.git ffmpeg-src
          cd ffmpeg-src
          git checkout release/6.1

      # ------------------------------------
      # Build FFmpeg (Clang targeting MSVC ABI)
      # ------------------------------------
      - name: Test MinGW Clang compiler
        shell: msys2 {0}
        run: |
          echo "Testing compilation..."
          echo "int main(){return 0;}" > test.c
          x86_64-w64-mingw32-clang test.c -o test.exe
          file test.exe
          
      - name: Build FFmpeg (MinGW Clang -> MSVC ABI)
        shell: msys2 {0}
        env:
          PREFIX: ${{ github.workspace }}/ffmpeg-windows
        run: |
          cd ffmpeg-src

          export CC=x86_64-w64-mingw32-clang
          export CXX=x86_64-w64-mingw32-clang++
          export AR=llvm-ar
          export RANLIB=llvm-ranlib
          export STRIP=llvm-strip

          ./configure \
            --enable-cross-compile
            --target-os=mingw32
            --arch=x86_64
            --cc="$CC" \
            --cxx="$CXX" \
            --ar="$AR" \
            --ranlib="$RANLIB" \
            --prefix="$PREFIX" \
            --disable-shared \
            --enable-static \
            --disable-programs \
            --disable-doc \
            --disable-debug \
            --disable-autodetect \
            --disable-everything \
            --enable-protocol=file \
            --enable-demuxer=mov,matroska,avi,mp3,aac,ogg,wav,flac \
            --enable-decoder=mp3,aac,vorbis,flac,h264,hevc,pcm_s16le \
            --enable-swresample \
            --enable-swscale \
            --enable-gpl \
            --enable-nonfree \
            --extra-cflags="-fuse-ld=lld -Wno-deprecated-declarations" \
            --extra-ldflags="-fuse-ld=lld"

          make -j$(nproc)
          make install

      # ------------------------------------
      # Build libretro-ffmpeg using MSVC
      # ------------------------------------
      - name: Build libretro-ffmpeg core (MSVC)
        shell: cmd
        working-directory: RetroArch\cores\libretro-ffmpeg
        env:
          FFMPEG_PREFIX: ${{ github.workspace }}\ffmpeg-windows
        run: |
          REM Load Visual Studio compiler environment
          CALL "%ProgramFiles(x86)%\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"

          SET INC_FFMPEG=/I "%FFMPEG_PREFIX%\include"
          SET LIB_FFMPEG="%FFMPEG_PREFIX%\lib\avcodec.lib" ^
                         "%FFMPEG_PREFIX%\lib\avformat.lib" ^
                         "%FFMPEG_PREFIX%\lib\avutil.lib" ^
                         "%FFMPEG_PREFIX%\lib\swresample.lib" ^
                         "%FFMPEG_PREFIX%\lib\swscale.lib"

          nmake /f Makefile.vc ^
            STATIC_LINK_FFMPEG=1 ^
            FFMPEG_DIR="%FFMPEG_PREFIX%" ^
            FFMPEG_INCLUDES="%INC_FFMPEG%" ^
            FFMPEG_LIBS="%LIB_FFMPEG%"

      # ------------------------------------
      # Strip the resulting DLL
      # ------------------------------------
      - name: Strip DLL
        shell: cmd
        working-directory: RetroArch\cores\libretro-ffmpeg
        run: |
          REM Use LLVM strip (works on clang/MSVC ABI)
          "%ProgramFiles%\LLVM\bin\llvm-strip.exe" ffmpeg_libretro.dll || echo "llvm-strip not found"

      # ------------------------------------
      # Package up the core
      # ------------------------------------
      - name: Zip core
        run: |
          powershell Compress-Archive `
            -LiteralPath RetroArch/cores/libretro-ffmpeg/ffmpeg_libretro.dll `
            -DestinationPath ffmpeg_libretro.dll.zip `
            -Force

      # ----------------------------
      # Upload release
      # ----------------------------
      - name: Publish release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: Windows_64-bit
          file: ffmpeg_libretro.dll.zip
          overwrite: true
